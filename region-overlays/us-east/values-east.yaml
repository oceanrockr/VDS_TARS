# T.A.R.S. US-East Region Configuration
# Primary region deployment values

# Global settings
global:
  region: us-east
  environment: production
  isPrimary: true

# Replication settings
replication:
  enabled: true
  role: primary
  replicas:
    - region: us-west
      endpoint: postgres-west.tars.svc.cluster.local

# PostgreSQL Configuration
postgresql:
  enabled: true
  architecture: replication

  # Primary database
  primary:
    name: postgres-primary
    persistence:
      enabled: true
      size: 200Gi
      storageClass: fast-ssd

    resources:
      limits:
        cpu: 4000m
        memory: 8Gi
      requests:
        cpu: 2000m
        memory: 4Gi

    # High availability
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - postgresql
          topologyKey: kubernetes.io/hostname

    # Node selector for region
    nodeSelector:
      region: us-east
      zone: us-east-1a

    # PostgreSQL configuration
    configuration: |
      # Replication settings
      wal_level = replica
      max_wal_senders = 10
      max_replication_slots = 10
      hot_standby = on

      # WAL archiving
      archive_mode = on
      archive_command = 'cp %p /var/lib/postgresql/wal_archive/%f'
      archive_timeout = 300

      # Performance tuning
      shared_buffers = 2GB
      effective_cache_size = 6GB
      maintenance_work_mem = 512MB
      checkpoint_completion_target = 0.9
      wal_buffers = 16MB
      default_statistics_target = 100
      random_page_cost = 1.1
      effective_io_concurrency = 200
      work_mem = 32MB
      min_wal_size = 1GB
      max_wal_size = 4GB
      max_worker_processes = 4
      max_parallel_workers_per_gather = 2
      max_parallel_workers = 4
      max_parallel_maintenance_workers = 2

      # Logging
      log_destination = 'stderr'
      logging_collector = on
      log_directory = 'log'
      log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
      log_rotation_age = 1d
      log_rotation_size = 100MB
      log_min_duration_statement = 1000
      log_checkpoints = on
      log_connections = on
      log_disconnections = on
      log_lock_waits = on
      log_temp_files = 0
      log_autovacuum_min_duration = 0
      log_replication_commands = on

      # Connections
      max_connections = 200

    # pg_hba.conf for replication
    pgHbaConfiguration: |
      # TYPE  DATABASE        USER            ADDRESS                 METHOD
      host    all             all             0.0.0.0/0               md5
      host    replication     replicator      0.0.0.0/0               md5
      host    all             all             ::1/128                 md5
      host    replication     replicator      ::1/128                 md5

  # Replication user
  replication:
    enabled: true
    user: replicator
    password: "changeme_replication"
    applicationName: tars-replication

    # Synchronous replication for data safety
    synchronousCommit: "remote_apply"
    numSynchronousReplicas: 1

  # Metrics
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      interval: 30s
    resources:
      limits:
        cpu: 200m
        memory: 256Mi

# Redis Cluster Configuration
redis:
  enabled: true
  architecture: cluster

  cluster:
    enabled: true
    nodes: 6  # 3 masters + 3 replicas
    replicas: 1

  master:
    count: 3
    persistence:
      enabled: true
      size: 20Gi
      storageClass: fast-ssd

    resources:
      limits:
        cpu: 1000m
        memory: 2Gi
      requests:
        cpu: 500m
        memory: 1Gi

    nodeSelector:
      region: us-east

    configuration: |
      # Cluster mode
      cluster-enabled yes
      cluster-config-file nodes.conf
      cluster-node-timeout 5000
      cluster-replica-validity-factor 0

      # Memory
      maxmemory 1.5gb
      maxmemory-policy allkeys-lru

      # Persistence
      save 900 1
      save 300 10
      save 60 10000
      appendonly yes
      appendfsync everysec

      # Network
      tcp-backlog 511
      timeout 0
      tcp-keepalive 300

      # Performance
      slowlog-log-slower-than 10000
      slowlog-max-len 128

  replica:
    replicaCount: 3
    persistence:
      enabled: true
      size: 20Gi

    resources:
      limits:
        cpu: 500m
        memory: 1Gi
      requests:
        cpu: 250m
        memory: 512Mi

  # Metrics
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      interval: 30s

# T.A.R.S. Backend Configuration
backend:
  replicaCount: 3

  image:
    repository: tars/backend
    tag: latest
    pullPolicy: Always

  resources:
    limits:
      cpu: 2000m
      memory: 4Gi
    requests:
      cpu: 1000m
      memory: 2Gi

  nodeSelector:
    region: us-east

  # Region-specific environment
  env:
    - name: REGION
      value: "us-east"
    - name: IS_PRIMARY
      value: "true"
    - name: DATABASE_HOST
      value: "postgres-primary"
    - name: DATABASE_REPLICATION_ENABLED
      value: "true"
    - name: REDIS_CLUSTER_NODES
      value: "redis-cluster-0.redis-cluster:6379,redis-cluster-1.redis-cluster:6379,redis-cluster-2.redis-cluster:6379"

  # Autoscaling
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 75

# ChromaDB Configuration
chromadb:
  enabled: true

  persistence:
    enabled: true
    size: 100Gi
    storageClass: fast-ssd

  replicaCount: 1

  resources:
    limits:
      cpu: 2000m
      memory: 8Gi
    requests:
      cpu: 1000m
      memory: 4Gi

  nodeSelector:
    region: us-east

# Ollama (LLM Service) Configuration
ollama:
  enabled: true

  gpu:
    enabled: true
    count: 1
    type: nvidia-tesla-t4

  resources:
    limits:
      nvidia.com/gpu: 1
      cpu: 4000m
      memory: 16Gi
    requests:
      nvidia.com/gpu: 1
      cpu: 2000m
      memory: 8Gi

  nodeSelector:
    region: us-east
    gpu: nvidia-tesla-t4

  models:
    - mistral:7b-instruct
    - llama2:13b

# Load Balancer Configuration
loadBalancer:
  enabled: true
  type: LoadBalancer

  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "http"

  healthCheck:
    enabled: true
    path: /health
    interval: 10s
    timeout: 5s

# Ingress Configuration
ingress:
  enabled: true
  className: nginx

  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

  hosts:
    - host: tars-east.example.com
      paths:
        - path: /
          pathType: Prefix

  tls:
    - secretName: tars-east-tls
      hosts:
        - tars-east.example.com

# Monitoring
monitoring:
  enabled: true

  serviceMonitor:
    enabled: true
    interval: 30s

  prometheusRule:
    enabled: true

# Backup Configuration
backup:
  enabled: true

  schedule: "0 2 * * *"  # 2 AM daily

  postgresql:
    enabled: true
    retention: 30  # days
    destination: s3://tars-backups-east/postgres

  chromadb:
    enabled: true
    retention: 30
    destination: s3://tars-backups-east/chromadb

  redis:
    enabled: true
    retention: 7
    destination: s3://tars-backups-east/redis
